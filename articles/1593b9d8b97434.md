---
title: "Spreadsheetã§Unpivot"
emoji: "ğŸ™„"
type: "tech"
topics:
  - "googlespreadshe"
published: true
published_at: "2023-03-10 15:45"
---

# æ¦‚è¦

Google Spreadsheetã®ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆé–¢æ•°(lambdaé–¢æ•°)ã§ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ”ãƒœãƒƒãƒˆè¡¨ã‚’

![](https://storage.googleapis.com/zenn-user-upload/5b6c027880e8-20230310.png)

ä»¥ä¸‹ã®ã‚ˆã†ãªç¸¦æŒã¡ã®ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/bdff53c0f900-20230310.png)

# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

Excelã«å¼•ãç¶šã„ã¦Google Spreadsheetã§ã‚‚lambdaé–¢æ•°ã€[leté–¢æ•°](https://workspaceupdates.googleblog.com/2023/01/google-sheets-powerful-functions-advanced-analysis.html)ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã€ã‚ã‚‹ç¨‹åº¦ã®å‡¦ç†ã¯GAS(Google Apps Script)ã‚’ä½¿ã‚ãªãã¦ã‚‚æ›¸ã‘ã‚‹ç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸã€‚ãã“ã§Power Queryã§é »å‡ºã™ã‚‹unpivotã‚’ã¤ãã£ã¦ã¿ã¾ã—ãŸã€‚

# å¯¾è±¡èª­è€…

- xlookup,let,lambdaãªã©Google Spreadsheetãƒ¯ãƒ¼ã‚¯ã‚·ãƒ¼ãƒˆé–¢æ•°ã€ãŠã‚ˆã³åå‰ä»˜ãé–¢æ•°ã‚’ä½¿ã„ã“ãªã›ã‚‹æ–¹

# å®Œæˆç³»

ä»¥ä¸‹ã‚’åå‰ä»˜ãé–¢æ•°ã¨ã—ã¦ç™»éŒ²ã—ã¦ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚dropé–¢æ•°ã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚Œã°ã‚ˆã‚Šç°¡æ½”ãªè¨˜è¼‰ã«ã§ããã†ã§ã™ã€‚

[ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ](https://docs.google.com/spreadsheets/d/1MlJlrXihGlsYYLZLzX6PAJaxVVdmxx1Us1--gnj9vlw/edit?usp=sharing)ã‹ã‚‰å®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã‚‹æ§˜å­ã‚’è¦‹ã¦é ‚ãã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```js
LAMBDA(
  range,
  let(
    drop,LAMBDA(
      range,
      col_to_drop,
      row_to_drop,
      makeArray(
        rows(range)-abs(row_to_drop),
        COLUMNS(range)-abs(col_to_drop),
        lambda(
          r,
          c,
          INDEX(
            range,
            r+if(row_to_drop>0,row_to_drop,0),
            c+if(col_to_drop>0,col_to_drop,0)
          )
        )
      )
    ),
    repeatCol,lambda(col,count,byCol(sequence(1,count),lambda(_,col))),
    repeatRow,lambda(row,count,byRow(sequence(count),lambda(_,row))),
    row_index,drop(chooseCols(range,1),0,1),
    height,rows(row_index),
    col_index,drop(chooseRows(range,1),1,0),
    width,COLUMNS(row),
    data,drop(range,1,1),
    result,{
      toCol(repeatRow(col_index,width)),
      toCol(repeatCol(row_index,height)),
      toCol(data)
    },
    result
  )
)
```

## ä½¿ç”¨ä¾‹

unpivoté–¢æ•°ã¯ã€Google Sheetsã§è¡¨å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¸¦ã«ä¸¦ã¹ãŸãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã«å¤‰æ›ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚ã“ã‚Œã¯ã€ç‰¹ã«ãƒ‡ãƒ¼ã‚¿åˆ†æã‚„ãƒ‡ãƒ¼ã‚¿æ•´å½¢ã«ãŠã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã«ä¾¿åˆ©ã§ã™ã€‚ä»¥ä¸‹ã«å…·ä½“çš„ãªä¾‹ã‚’ç¤ºã—ã€ä½¿ç”¨æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### ä¾‹: å•†å“åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ

ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•†å“åˆ¥ã®æœˆé–“å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

| å•†å“ | 1æœˆ | 2æœˆ | 3æœˆ |
|------|-----|-----|-----|
| A    | 100 | 150 | 120 |
| B    | 200 | 250 | 220 |
| C    | 300 | 350 | 320 |

ã“ã®è¡¨å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã«å¤‰æ›ã—ãŸã„ã¨ã—ã¾ã™ã€‚

| å•†å“ | æœˆ  | å£²ä¸Š |
|------|-----|-----|
| A    | 1æœˆ | 100 |
| A    | 2æœˆ | 150 |
| A    | 3æœˆ | 120 |
| B    | 1æœˆ | 200 |
| B    | 2æœˆ | 250 |
| B    | 3æœˆ | 220 |
| C    | 1æœˆ | 300 |
| C    | 2æœˆ | 350 |
| C    | 3æœˆ | 320 |

ã“ã®å¤‰æ›ã‚’è¡Œã†ãŸã‚ã«ã€unpivoté–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

1. Google Sheetsã§ã€ä¸Šè¨˜ã®å•†å“åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’A1:D4ã®ã‚»ãƒ«ã«å…¥åŠ›ã—ã¾ã™ã€‚
2. F1ã‹ã‚‰H1ã«ã‹ã‘ã¦å•†å“ã€æœˆã€å£²ä¸Šã¨äºˆã‚ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãŠãã¾ã™ã€‚
3. F2ã‚»ãƒ«ã«ã€`=unpivot(A1:D4)`ã¨å…¥åŠ›ã—ã¾ã™ã€‚

ã™ã‚‹ã¨ã€F1ã‚»ãƒ«ã‹ã‚‰å§‹ã¾ã‚‹ç¯„å›²ã«ã€ä¸Šè¨˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€unpivoté–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¡¨å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚„é›†è¨ˆãŒè¡Œã„ã‚„ã™ããªã‚Šã€ãƒ‡ãƒ¼ã‚¿åˆ†æã«å½¹ç«‹ã¡ã¾ã™ã€‚ã¾ãŸã€ä»–ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹éš›ã«ã‚‚ã€ã“ã®å½¢å¼ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚

# å®Ÿè£…ã«ã¤ã„ã¦ã®è§£èª¬

ã¾ãšãƒ”ãƒœãƒƒãƒˆè¡¨ã‚’è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãƒ‡ãƒ¼ã‚¿ã«åˆ†å‰²ã—ã¦è€ƒãˆã¾ã™

![](https://storage.googleapis.com/zenn-user-upload/1840e44e69ae-20230310.png)

è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å‡¦ç†ã‚’ã—ã€æœ€å¾Œã«çµ±åˆã—ã¦ã„ã¾ã™ã€‚

## è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3110fb86661c-20230310.png)

è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ©ãƒ™ãƒ«ã‚’åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ•°ã®åˆ†ã ã‘æ¨ªã«è¤‡å†™ã™ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã¨è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ©ãƒ™ãƒ«ã‚’1å¯¾1å¯¾å¿œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/865805bc8986-20230310.png)

ãã®ãŸã‚ã«repeatColã¨ã„ã†é–¢æ•°ã‚’ä½œã‚Šã¾ã™ã€‚

```js
lambda(col,count,byCol(sequence(1,count),lambda(_,col)))
```

sequence(è¡Œæ•°,åˆ—æ•°)ã¨ã„ã†é–¢æ•°ã¯é€£ç•ªã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚’ã¤ã‹ã£ã¦è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¨ªã«ä¸¦ã¹ã¾ã™ã€‚

## åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/228746e9eb09-20230310.png)

ã•ãã»ã©ã¨åŒã˜è¦é ˜ã§repeatRowã¨ã„ã†é–¢æ•°ã‚’ä½œã‚Šã¾ã™ã€‚

```js
lambda(row,count,byRow(sequence(count),lambda(_,row)))
```

## è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã‚‹

repeatColã¨repeatRowã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8831d5715232-20230310.png)

åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãã‚Œãã‚Œç¸¦1åˆ—ã«ã—ãŸä¸Šã§ä¸¦ã¹ã‚Œã°å®Œæˆã§ã™ã€‚ç¸¦1åˆ—ã«ä¸¦ã¹ã‚‹ãŸã‚ã«ã¯toColé–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’ä¸¦ã¹ã‚‹ã«ã¯HSTACKé–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚

åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
```js
HSTACK(
  toCol(lambda(col,count,byCol(sequence(1,count),lambda(_,col)))(col_index,cols(row_index))
),
  toCol(lambda(row,count,byRow(sequence(count),lambda(_,row)))(row_index,cols(col_index))
),
  toCol(data)
)
```

## è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’åˆ‡ã‚Šå‡ºã™

ä¸Šè¨˜ã¾ã§ã§å®Œæˆã§ã‚‚è‰¯ã„ã®ã§ã™ãŒã€ã›ã£ã‹ãã§ã™ã®ã§ç¯„å›²å…¨ä½“ã‚’æŒ‡å®šã™ã‚Œã°ã€è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•çš„ã«å–ã‚Šå‡ºã™ã‚ˆã†ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä¸€ç•ªå·¦ã®åˆ—ã‚’é¸æŠã—ãŸä¸Šã§ä¸€ç•ªä¸Šã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã€‚åˆ—ã®é¸æŠã¯choosecolsé–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚æŒ‡å®šã—ãŸè¡Œæ•°ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯dropé–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€ã¨è¨€ã„ãŸã„ã¨ã“ã‚ã§ã™ãŒExcelã«ã¯å­˜åœ¨ã™ã‚‹Dropé–¢æ•°ãŒSpreadsheetã«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ãã“ã§makearrayã¨ã„ã†æŒ‡å®šã—ãŸè¡Œæ•°ãƒ»åˆ—æ•°ã®é…åˆ—ã‚’ä½œã‚‹é–¢æ•°ã‚’ä½¿ã£ã¦è‡ªä½œã—ã¾ã™ã€‚

```js
LAMBDA(
      range,
      col_to_drop,
      row_to_drop,
      makeArray(
        rows(range)-abs(row_to_drop),
        COLUMNS(range)-abs(col_to_drop),
        lambda(
          r,
          c,
          INDEX(
            range,
            r+if(row_to_drop>0,row_to_drop,0),
            c+if(col_to_drop>0,col_to_drop,0)
          )
        )
      )
    )
 ```
 
 ã¡ãªã¿ã«dropã¨ã„ã†åå‰ã§åå‰ä»˜ãé–¢æ•°ã¨ã—ã¦ç™»éŒ²ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚å°†æ¥çš„ã«ã¯å®Ÿè£…ã•ã‚Œã‚‹ã®ã§ã—ã‚‡ã†ã€‚è‡ªä½œã®dropé–¢æ•°ã‚’ä½¿ã†ã¨è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å–ã‚Šå‡ºã—ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å…¨ä½“ã®ç¯„å›²ã¯rangeã¨ã—ã¾ã™ã€‚
 
 ```js
 drop(chooseCols(range,1),0,1)
 ```
 
 åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯chooserowã‚’ä½¿ã£ã¦1è¡Œç›®ã‚’å–ã‚Šå‡ºã—å…ˆé ­ã‚’å‰Šé™¤ã—ã¾ã—ã‚‡ã†ã€‚ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚
 
 ```js
 drop(chooseRows(range,1),1,0)
 ```
 
 ãƒ‡ãƒ¼ã‚¿ã¯1è¡Œç›®ã¨1åˆ—ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
 
 ```js
 drop(range,1,1)
 ```
 
 ## å…¨ä½“ã®çµ±åˆ
 
 å…¨ä½“ã‚’ã¾ã¨ã‚ã¦ä¸€ã¤ã®é–¢æ•°ã«ã—ã¾ã™ã€‚leté–¢æ•°ãŒç™»å ´ã™ã‚‹å‰ã¯ãƒã‚¹ãƒˆãŒæ·±ããªã£ãŸã‚Šã€å‡¦ç†ãŒå…¥ã‚Šçµ„ã‚“ã ã‚Šã—ã¦åˆ†ã‹ã‚Šã«ãããªã‚ŠãŒã¡ã§ã—ãŸãŒã€leté–¢æ•°ã«ã‚ˆã‚Šå¤‰æ•°ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã€å‡¦ç†ãŒè¿½ã„ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚å…¨ä½“ã‚’çµ„ã¿åˆã‚ã›ãŸçµæœã¯æœ€åˆã«æç¤ºã—ãŸã‚‚ã®ã¨åŒã˜ã§ã™ãŒå†æ²ã—ã¾ã™ã€‚
 
[ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ](https://docs.google.com/spreadsheets/d/1MlJlrXihGlsYYLZLzX6PAJaxVVdmxx1Us1--gnj9vlw/edit?usp=sharing)ã‹ã‚‰å®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã‚‹æ§˜å­ã‚’è¦‹ã¦é ‚ãã“ã¨ã‚‚ã§ãã¾ã™ã€‚
 
 ```js
LAMBDA(
  range,
  let(
    drop,LAMBDA(
      range,
      col_to_drop,
      row_to_drop,
      makeArray(
        rows(range)-abs(row_to_drop),
        COLUMNS(range)-abs(col_to_drop),
        lambda(
          r,
          c,
          INDEX(
            range,
            r+if(row_to_drop>0,row_to_drop,0),
            c+if(col_to_drop>0,col_to_drop,0)
          )
        )
      )
    ),
    repeatCol,lambda(col,count,byCol(sequence(1,count),lambda(_,col))),
    repeatRow,lambda(row,count,byRow(sequence(count),lambda(_,row))),
    row_index,drop(chooseCols(range,1),0,1),
    height,rows(row_index),
    col_index,drop(chooseRows(range,1),1,0),
    width,COLUMNS(row),
    data,drop(range,1,1),
    result,{
      toCol(repeatRow(col_index,width)),
      toCol(repeatCol(row_index,height)),
      toCol(data)
    },
    result
  )
)
```

# æœ€å¾Œã«

å§‹ã‚ã¦æŠ€è¡“è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚ç°¡å˜ãªé–¢æ•°ã®ã¤ã‚‚ã‚Šã§ã—ãŸãŒã€ãã¡ã‚“ã¨èª¬æ˜ã™ã‚‹ã®ã¯é›£ã—ã„ã§ã™ã­ã€‚

 